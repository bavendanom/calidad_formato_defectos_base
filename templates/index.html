<!DOCTYPE html>
<html lang="es">
<!--
================================================================================
SISTEMA DE REGISTRO DE DEFECTOS - INTERFAZ PRINCIPAL
================================================================================
Descripci√≥n: Interfaz web para el registro y seguimiento de defectos en l√≠neas
             de producci√≥n. Permite gesti√≥n en tiempo real, autoguardado,
             historial con filtros y panel de administraci√≥n.

Autor: Brayan Avenda√±o / Maquinando Controls
Versi√≥n: 2.0
Fecha: 2024

Tecnolog√≠as:
  - Bootstrap 5.3.3 (UI Framework)
  - Vanilla JavaScript (L√≥gica de negocio)
  - FastAPI Backend (API REST)
  
Estructura de pesta√±as:
  - L√≠neas 1-4: L√≠neas de producci√≥n principales
  - Tetrapack: L√≠nea especializada
  - Shot: L√≠nea de productos shot
  - Admin: Panel de administraci√≥n (requiere autenticaci√≥n)
================================================================================
-->

<head>
  <!-- ============================================ -->
  <!-- META INFORMACI√ìN -->
  <!-- ============================================ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de registro de defectos para control de calidad en l√≠neas de producci√≥n">
  <meta name="author" content="Brayan Avenda√±o / Maquinando Controls">
  
  <title>Registro de Defectos v2</title>
  
  <!-- ============================================ -->
  <!-- FAVICON -->
  <!-- ============================================ -->
  <link rel="icon" type="image/x-icon" href="../static/img/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../static/img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/img/apple-touch-icon.png">
  
  <!-- ============================================ -->
  
  <!-- ============================================ -->
  <!-- ESTILOS EXTERNOS -->
  <!-- ============================================ -->
  <!-- Bootstrap 5.3.3 - Framework CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Estilos personalizados del sistema -->
  <link rel="stylesheet" href="../static/style.css">
</head>

<body>
  <!-- ============================================ -->
  <!-- CONTENEDOR PRINCIPAL -->
  <!-- ============================================ -->
  <div class="container-fluid p-4">
    
    <!-- ============================================ -->
    <!-- HEADER: LOGOS Y T√çTULO -->
    <!-- ============================================ -->
    <div class="d-flex justify-content-between align-items-center mb-3 header-logos">
      <!-- Logo izquierdo -->
      <div class="logo-left">
        <img src="../static/img/logo_MC.png" alt="Logo Maquinando Controls" class="img-fluid">
      </div>
      
      <!-- T√≠tulo central -->
      <h3 class="text-primary text-center mb-0 flex-grow-1">
        üìã Registro de Defectos
      </h3>
      
      <!-- Logo derecho -->
      <div class="logo-right">
        <img src="../static/img/logo_ILC.png" alt="Logo ILC" class="img-fluid">
      </div>
    </div>

    <!-- ============================================ -->
    <!-- NAVEGACI√ìN: PESTA√ëAS DE L√çNEAS -->
    <!-- ============================================ -->
    <!--
      Sistema de navegaci√≥n por pesta√±as que permite cambiar entre diferentes
      l√≠neas de producci√≥n y el panel de administraci√≥n.
      
      Comportamiento:
        - Click en pesta√±a: Cambia l√≠nea activa
        - La pesta√±a "Admin" requiere autenticaci√≥n
        - Se mantiene estado por l√≠nea en localStorage
        - Cada l√≠nea tiene su propia configuraci√≥n de turnos
    -->
    <ul class="nav nav-pills justify-content-center mb-4" id="lineTabs">
      <li class="nav-item">
        <button class="nav-link active" data-linea="Linea 1">L√≠nea 1</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-linea="Linea 2">L√≠nea 2</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-linea="Linea 3">L√≠nea 3</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-linea="Linea 4">L√≠nea 4</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-linea="Tetrapack">Tetrapack</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-linea="Shot">Shot</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-linea="Admin">Admin</button>
      </li>
    </ul>

    <!-- ============================================ -->
    <!-- TARJETA PRINCIPAL DE CONTENIDO -->
    <!-- ============================================ -->
    <div class="card shadow-sm p-4" id="mainCard">
      
      <!-- ============================================ -->
      <!-- SECCI√ìN: FORMULARIO DE REGISTRO -->
      <!-- ============================================ -->
      <!--
        Formulario principal para registrar defectos.
        Contiene campos de informaci√≥n general y consulta de productos.
        
        Estados:
          - Visible: En l√≠neas de producci√≥n (1-4, Tetrapack, Shot)
          - Oculto: En pesta√±a Admin
      -->
      <div id="formSection">
        <div class="row g-4 mb-3">
          
          <!-- ========================================== -->
          <!-- COLUMNA IZQUIERDA: CAMPOS DE ENTRADA -->
          <!-- ========================================== -->
          <div class="col-lg-6">
            <div class="row g-3">
              
              <!-- Campo: Fecha -->
              <!--
                Input de fecha con bot√≥n "Hoy" para autocompletar.
                Formato: YYYY-MM-DD
              -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Fecha:</label>
                <div class="input-group">
                  <input 
                    type="date" 
                    id="fecha" 
                    class="form-control"
                    aria-label="Fecha de registro">
                  <button 
                    class="btn btn-outline-success" 
                    id="btnHoy"
                    title="Establecer fecha de hoy">
                    Hoy
                  </button>
                </div>
              </div>

              <!-- Campo: Inspector -->
              <!--
                Selector de inspector cargado din√°micamente desde la API.
                Se llena en la inicializaci√≥n mediante cargarInspectores()
              -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Inspector:</label>
                <select 
                  id="inspector" 
                  class="form-select" 
                  required
                  aria-label="Seleccionar inspector">
                  <option value="">Cargando...</option>
                </select>
              </div>

              <!-- Campo: C√≥digo AX -->
              <!--
                Input con autocompletado para c√≥digo de producto.
                Caracter√≠sticas:
                  - Autocompletado en tiempo real (>= 1 car√°cter)
                  - Navegaci√≥n con teclado (‚Üë‚Üì Enter Escape)
                  - Consulta autom√°tica al seleccionar
              -->
              <div class="col-md-6">
                <label class="form-label fw-bold">C√≥digo AX:</label>
                <div class="input-group">
                  <input 
                    type="text" 
                    id="codigoAX" 
                    class="form-control" 
                    placeholder="Ej: 4-03-0000-0019"
                    autocomplete="off"
                    aria-label="C√≥digo AX del producto">
                  <button 
                    class="btn btn-outline-primary" 
                    id="btnConsultar"
                    title="Consultar informaci√≥n del producto">
                    Consultar
                  </button>
                </div>
              </div>

              <!-- Campo: Lote -->
              <!--
                N√∫mero de lote del producto inspeccionado.
              -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Lote:</label>
                <input 
                  type="text" 
                  id="lote" 
                  class="form-control" 
                  placeholder="Ej: 115"
                  aria-label="N√∫mero de lote">
              </div>

            </div>
            
            <!-- ========================================== -->
            <!-- SELECTOR DE TURNO -->
            <!-- ========================================== -->
            <!--
              Selector de turno de trabajo.
              
              Turnos disponibles:
                1. 7:00 - 15:30   (Turno ma√±ana)
                2. 15:30 - 00:00  (Turno tarde)
                3. 7:00 - 18:00   (Turno extendido)
                4. 18:00 - 6:00   (Turno noche)
              
              Comportamiento:
                - Cambia horas de columnas en la tabla
                - Mantiene datos por posici√≥n (no por hora)
                - Se guarda en localStorage por l√≠nea
            -->
            <div class="mt-3 mb-2 d-flex flex-column align-items-start">
              <label class="fw-bold mb-2">Turno:</label>
              <div class="d-flex flex-wrap gap-2">
                <button 
                  class="btn btn-outline-primary btn-turno" 
                  data-turno="1"
                  title="Turno 1: Ma√±ana">
                  7:00 - 15:30
                </button>
                <button 
                  class="btn btn-outline-primary btn-turno" 
                  data-turno="2"
                  title="Turno 2: Tarde">
                  15:30 - 00:00
                </button>
                <button 
                  class="btn btn-outline-primary btn-turno" 
                  data-turno="3"
                  title="Turno 3: Extendido">
                  7:00 - 18:00
                </button>
                <button 
                  class="btn btn-outline-primary btn-turno" 
                  data-turno="4"
                  title="Turno 4: Noche">
                  18:00 - 6:00
                </button>
              </div>
            </div>
          </div>

          <!-- ========================================== -->
          <!-- COLUMNA DERECHA: INFORMACI√ìN DEL PRODUCTO -->
          <!-- ========================================== -->
          <!--
            Panel que muestra informaci√≥n consultada del producto.
            Se llena autom√°ticamente al consultar un c√≥digo AX v√°lido.
            
            Campos mostrados:
              - C√≥digo AX
              - Nombre del producto
              - Tipo de envase
              - Destino (nacional/exportaci√≥n)
              - L√≠neas de producci√≥n posibles
          -->
          <div class="col-lg-6">
            <label class="form-label fw-bold mb-2">Informaci√≥n del Producto:</label>
            <div id="infoProducto" class="p-3 border rounded bg-light h-95">
              <p class="mb-2">
                <strong>C√≥digo:</strong> 
                <span id="codigoInfo">---</span>
              </p>
              <p class="mb-2">
                <strong>Nombre:</strong> 
                <span id="nombreInfo">---</span>
              </p>
              <p class="mb-2">
                <strong>Envase:</strong> 
                <span id="envaseInfo">---</span>
              </p>
              <p class="mb-2">
                <strong>Destino:</strong> 
                <span id="destinoInfo">---</span>
              </p>
              <p class="mb-0">
                <strong>L√≠neas de producci√≥n:</strong> 
                <span id="lineasInfo">---</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECCI√ìN: TABLA DE DEFECTOS -->
      <!-- ============================================ -->
      <!--
        Contenedor donde se renderiza din√°micamente la tabla de defectos.
        
        Caracter√≠sticas:
          - Generada 100% por JavaScript seg√∫n l√≠nea activa
          - Celdas editables (contenteditable)
          - Validaci√≥n en tiempo real (solo n√∫meros)
          - Autoguardado en localStorage
          - Suma autom√°tica por fila (Total d√≠a)
          - Resaltado de celda/fila/columna activa
          - Observaciones por tipo de defecto
        
        Estructura generada:
          thead: Encabezado con horas del turno
          tbody:
            - Fila tipo de defecto (color, nombre)
            - Filas de descripci√≥n (celdas editables)
            - Fila de observaciones (input texto)
            - [Se repite para cada tipo de defecto]
      -->
      <div 
        id="tablaDefectos" 
        class="mt-4 text-center text-muted border p-5 rounded"
        role="region"
        aria-label="Tabla de registro de defectos">
        <p>[ Aqu√≠ se cargar√° din√°micamente la tabla de defectos seg√∫n la l√≠nea seleccionada ]</p>
      </div>

      <!-- ============================================ -->
      <!-- BOT√ìN: GUARDAR REGISTRO -->
      <!-- ============================================ -->
      <!--
        Bot√≥n principal de guardado.
        
        Flujo:
          1. Valida campos obligatorios
          2. Verifica que haya datos (suma > 0)
          3. Muestra modal de confirmaci√≥n
          4. Al confirmar: Guarda en backend
          5. Limpia formulario y recarga historial
        
        Guarda en dos tablas:
          - tipos_defectos: Totales por tipo
          - tipos_defectos_descripcion: Detalle por hora
      -->
      <div class="text-end mt-3">
        <button 
          class="btn btn-success btn-lg px-5" 
          id="btnGuardar"
          title="Guardar registro de defectos">
          üíæ Guardar
        </button>
      </div>

      <!-- ============================================ -->
      <!-- MODAL: CONFIRMACI√ìN DE GUARDADO -->
      <!-- ============================================ -->
      <!--
        Modal de confirmaci√≥n antes de guardar datos.
        Previene guardados accidentales.
      -->
      <div 
        class="modal fade" 
        id="modalConfirmarGuardado" 
        tabindex="-1" 
        aria-labelledby="modalConfirmarGuardadoLabel" 
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Header del modal -->
            <div class="modal-header bg-warning text-dark">
              <div class="d-flex justify-content-between align-items-center mb-3 header-logos">
                <div class="logo-left" style="width: 40px; height: 40px;">
                  <img src="../static/img/logo_ILC.png" alt="Logo ILC" class="img-fluid">
                </div>
                <h5 class="text-primary text-center mb-0 flex-grow-1">
                  Confirmar guardado
                </h5>
              </div>
              <button 
                type="button" 
                class="btn-close" 
                data-bs-dismiss="modal" 
                aria-label="Cerrar">
              </button>
            </div>
            
            <!-- Cuerpo del modal -->
            <div class="modal-body text-center">
              <div class="mb-3">
                <i class="bi bi-question-circle-fill text-warning" style="font-size: 3rem;"></i>
              </div>
              <h5>¬øEst√° seguro de guardar los datos?</h5>
              <p class="text-muted mb-0">
                Esta acci√≥n guardar√° los registros en la base de datos.
              </p>
            </div>
            
            <!-- Footer con botones -->
            <div class="modal-footer justify-content-center">
              <button 
                type="button" 
                class="btn btn-secondary px-4" 
                data-bs-dismiss="modal">
                ‚ùå Cancelar
              </button>
              <button 
                type="button" 
                class="btn btn-success px-4" 
                id="btnConfirmarGuardado">
                ‚úÖ Aceptar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- MODAL: LOGIN ADMINISTRADOR -->
      <!-- ============================================ -->
      <!--
        Modal de autenticaci√≥n para acceder al panel de administraci√≥n.
        
        Caracter√≠sticas:
          - 3 intentos fallidos ‚Üí bloqueo temporal (30 segundos)
          - Contador de intentos visible
          - Feedback de error en tiempo real
          - No se puede cerrar con click fuera (backdrop="static")
      -->
      <div 
        class="modal fade" 
        id="modalLoginAdmin" 
        data-bs-backdrop="static" 
        data-bs-keyboard="false" 
        tabindex="-1" 
        aria-labelledby="modalLoginAdminLabel" 
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Header del modal -->
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="modalLoginAdminLabel">
                üîí Acceso Administrativo
              </h5>
            </div>
            
            <!-- Cuerpo del modal -->
            <div class="modal-body">
              <!-- Icono de seguridad -->
              <div class="text-center mb-3">
                <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
              </div>
              
              <p class="text-center mb-3">
                Ingrese la contrase√±a de administrador para continuar
              </p>
              
              <!-- Campo de contrase√±a -->
              <div class="mb-3">
                <label for="passwordAdmin" class="form-label fw-bold">Contrase√±a:</label>
                <input 
                  type="password" 
                  class="form-control" 
                  id="passwordAdmin" 
                  placeholder="Ingrese la contrase√±a"
                  autocomplete="off"
                  aria-label="Contrase√±a de administrador">
              </div>

              <!-- Mensaje de error (oculto por defecto) -->
              <div id="errorLoginAdmin" class="alert alert-danger d-none" role="alert">
                <strong>‚ùå Error:</strong> 
                <span id="mensajeErrorLogin"></span>
              </div>

              <!-- Mensaje de bloqueo (oculto por defecto) -->
              <div id="bloqueoLoginAdmin" class="alert alert-warning d-none" role="alert">
                <strong>‚è≥ Bloqueado:</strong> 
                Demasiados intentos fallidos. Espere 
                <span id="tiempoBloqueo">30</span> segundos.
              </div>

              <!-- Contador de intentos -->
              <div class="text-muted small">
                <strong>Intentos restantes:</strong> 
                <span id="intentosRestantes">3</span>/3
              </div>
            </div>
            
            <!-- Footer con botones -->
            <div class="modal-footer">
              <button 
                type="button" 
                class="btn btn-secondary" 
                id="btnCancelarLoginAdmin">
                ‚ùå Cancelar
              </button>
              <button 
                type="button" 
                class="btn btn-primary" 
                id="btnIngresarAdmin">
                ‚úÖ Ingresar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECCI√ìN: HISTORIAL DE REGISTROS -->
      <!-- ============================================ -->
      <!--
        Panel de historial con filtros avanzados y paginaci√≥n.
        
        Caracter√≠sticas:
          - Dos vistas: Detallado y Resumen
          - Filtros m√∫ltiples (fecha, tipo, lote, c√≥digo)
          - Paginaci√≥n (20 registros por p√°gina)
          - Autocompletado en filtro de c√≥digo
          - Colores por tipo de defecto
          - Actualizaci√≥n autom√°tica despu√©s de guardar
      -->
      <div id="seccionHistorial" class="historial-section mt-5">
        
        <!-- Header del historial -->
        <div class="historial-header d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">
            üìã Historial de Registros - 
            <span id="tituloLineaHistorial">L√≠nea 1</span>
          </h4>
          
          <!-- Botones de control -->
          <div class="btn-group" role="group" aria-label="Controles de historial">
            <button 
              class="btn btn-sm btn-primary active" 
              id="btnHistorialDetallado"
              title="Vista detallada por hora">
              üìä Detallado
            </button>
            <button 
              class="btn btn-sm btn-outline-success" 
              id="btnHistorialResumen"
              title="Vista resumida por tipo">
              üìà Resumen
            </button>
            <button 
              class="btn btn-sm btn-outline-secondary" 
              id="btnRefrescarHistorial"
              title="Recargar historial">
              üîÑ Refrescar
            </button>
          </div>
        </div>

        <!-- ========================================== -->
        <!-- PANEL DE FILTROS -->
        <!-- ========================================== -->
        <div class="filtros-historial card p-3 mb-3">
          <div class="row g-2">
            
            <!-- Filtro: Fecha de inicio -->
            <div class="col-md-3">
              <label class="form-label fw-bold">Fecha inicio:</label>
              <input 
                type="date" 
                id="filtroFechaInicio" 
                class="form-control form-control-sm"
                aria-label="Fecha de inicio del filtro">
            </div>
            
            <!-- Filtro: Fecha de fin -->
            <div class="col-md-3">
              <label class="form-label fw-bold">Fecha fin:</label>
              <input 
                type="date" 
                id="filtroFechaFin" 
                class="form-control form-control-sm"
                aria-label="Fecha de fin del filtro">
            </div>
            
            <!-- Filtro: Tipo de defecto -->
            <div class="col-md-3">
              <label class="form-label fw-bold">Tipo de defecto:</label>
              <select 
                id="filtroTipoDefecto" 
                class="form-select form-select-sm"
                aria-label="Filtrar por tipo de defecto">
                <option value="todos">Todos</option>
                <!-- Opciones cargadas din√°micamente -->
              </select>
            </div>
            
            <!-- Filtro: Lote -->
            <div class="col-md-2">
              <label class="form-label fw-bold">Lote:</label>
              <input 
                type="text" 
                id="filtroLote" 
                class="form-control form-control-sm" 
                placeholder="Ej: 115"
                aria-label="Filtrar por lote">
            </div>
            
            <!-- Filtro: C√≥digo AX (con autocompletado) -->
            <div class="col-md-2">
              <label class="form-label fw-bold">C√≥digo AX:</label>
              <div style="position: relative;">
                <input 
                  type="text" 
                  id="filtroCodigoAX" 
                  class="form-control form-control-sm" 
                  placeholder="Ej: 4-03-0000-0019"
                  autocomplete="off"
                  aria-label="Filtrar por c√≥digo AX">
                <!-- Contenedor de autocompletado generado por JS -->
              </div>
            </div>
            
            <!-- Bot√≥n aplicar filtros -->
            <div class="col-md-3 d-flex align-items-end">
              <button 
                class="btn btn-success btn-sm w-100" 
                id="btnAplicarFiltros"
                title="Aplicar filtros seleccionados">
                üîç Aplicar Filtros
              </button>
            </div>
          </div>
        </div>

        <!-- ========================================== -->
        <!-- TABLA DE HISTORIAL -->
        <!-- ========================================== -->
        <!--
          Tabla responsive con scroll vertical.
          Las columnas se adaptan seg√∫n la vista (detallado/resumen).
          
          Vista Detallada:
            ID | Fecha | Hora | C√≥digo | Lote | Nombre | Envase | 
            Destino | Tipo | Descripci√≥n | Cantidad
          
          Vista Resumen:
            ID | Fecha/Hora | C√≥digo | Lote | Nombre | Envase | 
            Destino | Tipo | Observaciones | Total
        -->
        <div class="table-responsive">
          <table class="table table-sm table-bordered historial-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>C√≥digo</th>
                <th>Lote</th>
                <th>Nombre</th>
                <th>Envase</th>
                <th>Destino</th>
                <th>Tipo Defecto</th>
                <th>Descripci√≥n</th>
                <th>Cantidad</th>
              </tr>
            </thead>
            <tbody id="historialTableBody">
              <tr>
                <td colspan="11" class="text-center">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ========================================== -->
        <!-- PAGINACI√ìN -->
        <!-- ========================================== -->
        <!--
          Controles de paginaci√≥n generados din√°micamente.
          Muestra: Anterior | 1 2 ... 5 6 7 ... 10 | Siguiente
          L√≠mite: M√°ximo 10 p√°ginas visibles
        -->
        <div 
          class="paginacion-historial" 
          id="paginacionHistorial"
          role="navigation"
          aria-label="Paginaci√≥n del historial">
          <!-- Contenido generado din√°micamente por JS -->
        </div>
      </div>

    </div>
  </div>

  <!-- ============================================ -->
  <!-- SCRIPTS EXTERNOS -->
  <!-- ============================================ -->
  <!-- Bootstrap Bundle (incluye Popper.js) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Script principal del sistema -->
  <script src="../static/script.js"></script>
</body>
</html>